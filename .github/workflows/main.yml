name: Show GitHub OIDC Token

on:
  workflow_dispatch:   # allows manual run from Actions tab

jobs:
  show-jwt:
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # 👈 REQUIRED for OIDC
      contents: read

    steps:
      - name: Request OIDC token
        run: |
          echo "Fetching GitHub OIDC token..."
          RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                      "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=oci")

          echo "Raw response from GitHub:"
          echo "$RESPONSE"

          TOKEN=$(echo "$RESPONSE" | jq -r '.value')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ No token returned."
            exit 1
          fi

          echo
          echo "✅ JWT token (first 200 chars):"
          echo "${TOKEN:0:200}..."

          echo
          echo "🔎 Decoded JWT header:"
          echo $TOKEN | cut -d "." -f1 | tr '_-' '/+' | base64 -d 2>/dev/null || true

          echo
          echo "🔎 Decoded JWT claims:"
          echo $TOKEN | cut -d "." -f2 | tr '_-' '/+' | base64 -d 2>/dev/null || true
